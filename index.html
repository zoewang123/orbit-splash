<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Orbit Swap</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:"Trebuchet MS",Verdana,sans-serif}
canvas{display:block;touch-action:manipulation}
</style>
<canvas id="c"></canvas>
<script>
const c=document.getElementById("c"),x=c.getContext("2d");
const TAU=Math.PI*2,GAP=TAU/36,AC=window.AudioContext||window.webkitAudioContext,OC=window.OfflineAudioContext||window.webkitOfflineAudioContext;
let w,h,cx,cy,base1,base2,r1,r2,dpr=1,obs=[],gems=[],parts=[],orbit=0,score=0,bullets=[],state=0,last=0,spawnT=0,shake=0,ringShift=0,targetShift=0,shiftT=0,hit=0,hitC="#fff",waveA=0,waveK=4,waveK2=4,waveM=1,waveTM=1,waveTA=0,waveT=0,waveP1=0,waveP2=TAU/4,waveS1=0,waveS2=0,waveTS1=0,waveTS2=0,musicReady=0,musicMode=0,ac=0,an=0,src=0,buf=0,arr=0,audioE=0,audS=0,audI=0,audL=0,bpm=0,beatP=0,beatT=0,beatOff=0,musicStart=0,btnX=0,btnY=0,btnW=0,btnH=0;
const ad=(a,b)=>{let d=Math.abs(a-b)%TAU;return d>Math.PI?TAU-d:d;};
function resize(){
  dpr=devicePixelRatio||1;
  w=innerWidth;h=innerHeight;
  c.width=w*dpr;c.height=h*dpr;
  c.style.width=w+"px";c.style.height=h+"px";
  x.setTransform(dpr,0,0,dpr,0,0);
  cx=w/2;cy=h/2;
  base1=Math.min(w,h)*0.18;
  base2=base1*1.8;
  r1=base1;r2=base2;
}
addEventListener("resize",resize);resize();
function reset(){
  obs=[];gems=[];parts=[];orbit=0;score=0;bullets=[];spawnT=0;state=1;shake=0;ringShift=0;targetShift=0;shiftT=2+Math.random()*2;hit=0;waveA=0;waveTA=0;waveK=4;waveK2=4;waveM=1;waveTM=1;waveT=0;waveP1=0;waveP2=TAU/4;waveS1=0;waveS2=0;waveTS1=0;waveTS2=0;
  if(musicMode&&buf)startAudio();else stopAudio();
}
function tap(e){
  if(state===0){
    if(e&&btnW&&e.clientX>btnX-btnW/2&&e.clientX<btnX+btnW/2&&e.clientY>btnY-btnH/2&&e.clientY<btnY+btnH/2){
      if(musicReady>0){musicMode=1;reset();}else if(musicReady===0){inp.value="";inp.click();}
      return;
    }
    musicMode=0;reset();return;
  }else if(state===2)reset();
  else orbit=1-orbit;
}
addEventListener("pointerdown",tap);
addEventListener("keydown",e=>{if(e.key===" "||e.key==="ArrowUp"||e.key==="ArrowDown")tap();});
const inp=document.createElement("input");
inp.type="file";inp.accept="audio/*";inp.style.display="none";document.body.appendChild(inp);
function startAudio(){
  if(!AC||!buf||!musicMode)return;
  if(!ac)ac=new AC();
  if(ac.state==="suspended")ac.resume();
  if(src)try{src.stop()}catch(e){}
  src=ac.createBufferSource();src.buffer=buf;
  an=ac.createAnalyser();an.fftSize=256;
  src.connect(an);an.connect(ac.destination);
  src.start(0);arr=new Uint8Array(an.fftSize);musicStart=ac.currentTime;beatT=ac.currentTime+(beatOff||0);
}
function stopAudio(){if(src)try{src.stop()}catch(e){}src=0;}
// Beat analysis adapted from BeatDetect.js method (peak-picking + interval grouping + offset).
// Source: https://arthurbeaulieu.github.io/BeatDetect.js/ (see docs for algorithm details)
function bd(buf){
  return new Promise(r=>{
    if(!OC)return r({bpm:0,offset:0});
    const sr=buf.sampleRate,len=Math.min(buf.length,(sr*15)|0);
    const off=new OC(2,len,sr),src=off.createBufferSource();
    const lo=off.createBiquadFilter(),hi=off.createBiquadFilter();
    src.buffer=buf;lo.type="lowpass";lo.frequency.value=150;hi.type="highpass";hi.frequency.value=100;
    src.connect(lo);lo.connect(hi);hi.connect(off.destination);
    src.start(0,0,len/sr);
    off.startRendering().then(b=>{
      const L=b.getChannelData(0),R=b.getChannelData(1),p=pk(L,R,sr),t=tp(p,sr),o=of(L,sr,t);
      r({bpm:t,offset:o.offset||0,firstBar:o.firstBar||0});
    });
  });
}
function pk(L,R,sr){
  const ps=sr/2,parts=(L.length/ps)|0,peaks=[];
  for(let i=0;i<parts;i++){
    let m=0,pos=i*ps;
    for(let j=pos;j<(i+1)*ps&&j<L.length;j++){
      const v=Math.max(Math.abs(L[j]),Math.abs(R[j]||0));
      if(v>m){m=v;pos=j;}
    }
    peaks.push({pos,vol:m});
  }
  peaks.sort((a,b)=>b.vol-a.vol);
  peaks.splice((peaks.length*0.5)|0);
  peaks.sort((a,b)=>a.pos-b.pos);
  return peaks;
}
function tp(peaks,sr){
  const g=[];
  for(let i=0;i<peaks.length;i++)for(let j=1;j<10&&i+j<peaks.length;j++){
    let t=60*sr/(peaks[i+j].pos-peaks[i].pos);
    while(t<90)t*=2;while(t>180)t/=2;t=Math.round(t);
    const e=g.find(v=>v.t===t);if(e)e.c++;else g.push({t,c:1});
  }
  g.sort((a,b)=>b.c-a.c);
  return g[0]?g[0].t:0;
}
function loff(pos,sr,bpm){
  const bt=60/bpm;let o=pos/sr;
  while(o>=bt)o-=bt*4;
  if(o<0)while(o<0)o+=bt;
  return o;
}
function of(data,sr,bpm){
  if(!bpm)return {offset:0,firstBar:0};
  const ps=sr/2,parts=(data.length/ps)|0,peaks=[];
  for(let i=0;i<parts;i++){
    let m=0,pos=i*ps;
    for(let j=pos;j<(i+1)*ps&&j<data.length;j++){
      const v=Math.abs(data[j]);if(v>m){m=v;pos=j;}
    }
    peaks.push({pos:pos-Math.round((60/bpm*.05)*sr),vol:m});
  }
  if(!peaks.length)return {offset:0,firstBar:0};
  const u=peaks.slice();peaks.sort((a,b)=>b.vol-a.vol);
  const ref=loff(peaks[0].pos,sr,bpm);let mean=0,div=0;
  for(const p of peaks){const o=loff(p.pos,sr,bpm);if(Math.abs(o-ref)<.05){mean+=o;div++;}}
  let i=0;while(i<u.length&&u[i].vol<.02)i++;
  let fb=(u[i]?u[i].pos:0)/sr,m=div?mean/div:0;
  if(fb>m&&fb<60/bpm)fb=m;
  return {offset:m,firstBar:fb};
}
inp.onchange=()=>{
  const f=inp.files&&inp.files[0];if(!f||!AC)return;
  musicReady=-1;
  const r=new FileReader();
  r.onload=e=>{
    if(!ac)ac=new AC();
    ac.resume();
    ac.decodeAudioData(e.target.result).then(b=>{
      buf=b;musicReady=-2;
      bd(b).then(info=>{bpm=info.bpm||0;beatP=bpm?60/bpm:0;beatOff=info.offset||0;musicReady=1;});
    });
  };
  r.readAsArrayBuffer(f);
};
function spawn(){
  let a=3.2+Math.random()*2.6,o=Math.random()<.5?0:1;
  if(Math.random()<.22){gems.push({a,o});return;}
  let ok=false;
  for(let i=0;i<6;i++){
    ok=true;
    for(const ob of obs)if(ob.o!==o&&ad(a,ob.a)<GAP){ok=false;break;}
    if(ok)break;
    a=3.2+Math.random()*2.6;
  }
  if(ok)obs.push({a,o});else gems.push({a,o});
}
function drawText(t,y,s){
  x.fillStyle="rgba(255,255,255,.9)";
  x.font=(s||24)+"px \"Trebuchet MS\",Verdana,sans-serif";
  x.textAlign="center";x.fillText(t,cx,y);
}
function waveV(a,p){
  const m=waveM*waveM*(3-2*waveM),ap=a+p;
  return (1-m)*Math.cos(ap*waveK)+m*Math.cos(ap*waveK2);
}
function radAt(a,o){
  const r=o?r2:r1;
  const p=o?waveP2:waveP1;
  return r*(1+waveA*waveV(a,p));
}
function pos(a,o){
  const r=radAt(a,o);
  return [cx+Math.sin(a)*r,cy-Math.cos(a)*r];
}
function burst(px,py,col,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*TAU,s=.7+Math.random()*2.2;
    parts.push({x:px,y:py,vx:Math.cos(a)*s,vy:Math.sin(a)*s,t:.45+Math.random()*.25,c:col});
  }
}
function loop(t){
  requestAnimationFrame(loop);
  const dt=Math.min(.033,(t-last||0)/1e3);last=t||0;
  if(an&&arr){
    an.getByteTimeDomainData(arr);
    let s=0;for(let i=0;i<arr.length;i++){const v=arr[i]-128;s+=v*v;}
    audioE=Math.sqrt(s/arr.length)/128;
  }else audioE=0;
  if(musicMode){
    audS+= (audioE-audS)*dt*6;
    audI+= (audioE-audI)*dt*1.2;
    audL+= (audioE-audL)*dt*.18;
  }else{audS=audI=audL=0;}
  if(hit>0)hit=Math.max(0,hit-dt*2.2);
  const warm=musicMode&&ac?Math.min(1,(ac.currentTime-musicStart)/3):1;
  const bt=(musicMode&&beatP&&ac)?((ac.currentTime-beatT)/beatP)%1:0;
  const bp=musicMode&&beatP?Math.exp(-Math.pow(Math.min(bt,1-bt)*8,2)):0;
  const shiftOn=musicMode?score>=20:score>=40;
  if(shiftOn){
    shiftT-=dt;
    if(shiftT<=0){targetShift=1-targetShift;shiftT=3+Math.random()*4;}
  }else{targetShift=0;}
  ringShift+= (targetShift-ringShift)*dt*0.6;
  const waveOn=musicMode||score>=20||shiftOn;
  if(waveOn){
    let inten=0;
    waveT-=dt;
    if(waveT<=0){
      waveTS1=(Math.random()<.5?-1:1)*(.2+Math.random()*1.2);
      waveTS2=(Math.random()<.5?-1:1)*(.3+Math.random()*1.5);
      waveT=(musicMode?2.2:2)+Math.random()*(musicMode?2.6:3);
      if(!musicMode){
        waveK2=2*(1+(Math.random()*4|0));
        waveM=0;
        waveTM=1.2+Math.random()*1.8;
        waveTA=.05+Math.random()*.08;
      }
    }
    if(musicMode){
      const rel=audL?audioE/audL:0,boost=Math.max(0,audS-audI);
      const ib=Math.min(1,Math.max(0,(rel-1)*.4)+boost*1.1+bp*.4);
      inten=ib*(.3+.7*warm);
      const ta=(.04+Math.min(.26,audS*.45+Math.max(0,rel-1)*.08+bp*.18))*warm;
      waveA+= (ta-waveA)*dt*3;
      const kt=2+2*Math.min(3,Math.round(inten*3));
      if(kt!==waveK2){waveK2=kt;waveM=0;waveTM=.45+(1-inten)*.55;}
    }else{
      waveA+= (waveTA-waveA)*dt*0.7;
    }
    if(waveM<1){waveM=Math.min(1,waveM+dt/waveTM);if(waveM>=1)waveK=waveK2;}
    const m=musicMode?(.5+inten*1.8):1;
    waveS1+= (waveTS1*m-waveS1)*dt*1;
    waveS2+= (waveTS2*m-waveS2)*dt*1;
    waveP1+= dt*waveS1;waveP2+= dt*waveS2;
    if(waveP1>TAU)waveP1-=TAU;else if(waveP1<-TAU)waveP1+=TAU;
    if(waveP2>TAU)waveP2-=TAU;else if(waveP2<-TAU)waveP2+=TAU;
  }else{
    waveTA=0;waveA+= (waveTA-waveA)*dt*1.2;
  }
  const d1=1+Math.sin(t/900)*.08,d2=1+Math.sin(t/750+1.7)*.06;
  const a=base1*d1,b=base2*d2;
  r1=a+(b-a)*ringShift;
  r2=b+(a-b)*ringShift;
  if(state===1){
    score+=dt;
    while(bullets.length&&bullets[0]<=score)bullets.shift();
    const speed=1.6+score*0.02;
    spawnT-=dt;if(spawnT<=0){spawn();spawnT=.55+Math.random()*.35-Math.min(.35,score*.002);}
    for(let i=obs.length-1;i>=0;i--){
      const o=obs[i];o.a-=speed*dt;
      if(o.a<-0.4)obs.splice(i,1);
      else if(Math.abs(o.a)<.12&&o.o===orbit){
        const p=pos(o.a,o.o);
        if(bullets.length){bullets.shift();obs.splice(i,1);shake=12;hit=.25;hitC="#9df5ff";burst(p[0],p[1],"#9df5ff",12);}
        else {state=2;shake=26;hit=.6;hitC="#ff5b5b";burst(p[0],p[1],"#ff6b6b",22);}
      }
    }
    for(let i=gems.length-1;i>=0;i--){
      const g=gems[i];g.a-=speed*dt;
      if(g.a<-0.4)gems.splice(i,1);
      else if(Math.abs(g.a)<.12&&g.o===orbit){
        bullets.push(score+5);gems.splice(i,1);
        const p=pos(g.a,g.o);burst(p[0],p[1],"#7dffb3",8);
      }
    }
  }
  x.clearRect(0,0,w,h);
  const g=x.createRadialGradient(cx,cy,0,cx,cy,Math.max(w,h));
  g.addColorStop(0,"#08141f");g.addColorStop(1,"#000");
  x.fillStyle=g;x.fillRect(0,0,w,h);
  if(hit>0){x.fillStyle=hitC;x.globalAlpha=hit*.35;x.fillRect(0,0,w,h);x.globalAlpha=1;}
  if(shake>0){shake-=dt*22;x.translate((Math.random()-.5)*shake*1.4,(Math.random()-.5)*shake*1.4);}
  x.strokeStyle="rgba(80,220,255,.18)";x.lineWidth=2.2;
  function ringColor(p){
    const h=160+120*(0.5+0.5*Math.sin(p)),l=66,a=.35+.25*waveA;
    return "hsla("+h+",95%,"+l+"%,"+a+")";
  }
  function ringPath(r,p){
    if(waveA>.002){
      const n=48,pts=[];
      for(let i=0;i<n;i++){
        const a=i/n*TAU,rr=r*(1+waveA*waveV(a,p));
        pts.push([cx+Math.sin(a)*rr,cy-Math.cos(a)*rr]);
      }
      const p0=pts[0],pN=pts[n-1];
      x.moveTo((pN[0]+p0[0])/2,(pN[1]+p0[1])/2);
      for(let i=0;i<n;i++){
        const p=pts[i],p2=pts[(i+1)%n];
        x.quadraticCurveTo(p[0],p[1],(p[0]+p2[0])/2,(p[1]+p2[1])/2);
      }
    }else x.arc(cx,cy,r,0,TAU);
  }
  x.beginPath();ringPath(r1,waveP1);x.strokeStyle=ringColor(waveP1);x.shadowBlur=14;x.shadowColor=x.strokeStyle;x.stroke();
  x.beginPath();ringPath(r2,waveP2);x.strokeStyle=ringColor(waveP2);x.shadowBlur=14;x.shadowColor=x.strokeStyle;x.stroke();
  x.shadowBlur=0;
  const pulse=.02+Math.sin(t/500)*.01;
  function drawDot(a,o,col,rad){
    const r=radAt(a,o),px=cx+Math.sin(a)*r,py=cy-Math.cos(a)*r;
    x.fillStyle=col;x.beginPath();x.arc(px,py,rad,0,TAU);x.fill();
  }
  for(const o of obs)drawDot(o.a,o.o,"#ff6b6b",7);
  for(const g of gems)drawDot(g.a,g.o,"#7dffb3",5);
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];p.t-=dt;
    if(p.t<=0){parts.splice(i,1);continue;}
    p.x+=p.vx*(dt*60);p.y+=p.vy*(dt*60);
    x.fillStyle=p.c;x.globalAlpha=Math.min(1,p.t*2);
    x.fillRect(p.x-1.5,p.y-1.5,3,3);
  }
  x.globalAlpha=1;
  const pr=orbit?r2:r1;
  x.shadowBlur=18;x.shadowColor="rgba(120,220,255,.6)";
  drawDot(0,orbit,"#fff",7+pr*pulse);
  x.shadowBlur=0;
  x.fillStyle="rgba(255,255,255,.8)";
  x.font="16px \"Trebuchet MS\",Verdana,sans-serif";x.textAlign="left";
  x.fillText("Score "+(score|0),12,24);
  const bc=bullets.length;
  x.textAlign="right";
  x.fillText("Bullets "+bc,w-12,24);
  x.fillStyle="rgba(160,220,255,.9)";
  const max=10,show=Math.min(bc,max),sp=10,br=5,by=24;
  let bx=cx-(show-1)*sp/2;
  for(let i=0;i<show;i++){x.beginPath();x.arc(bx+i*sp,by,br,0,TAU);x.fill();}
  if(bc>max){x.fillRect(bx-sp-3,by-1,6,2);}
  if(state===0){
    drawText("Orbit Swap",cy-20,36);
    drawText("Tap to start",cy+18,18);
    const label=musicReady>0?"Music Mode":(musicReady===-2?"Analyzing...":(musicReady<0?"Loading...":"Load Music"));
    x.font="18px \"Trebuchet MS\",Verdana,sans-serif";
    btnW=x.measureText(label).width+36;btnH=30;btnX=cx;btnY=h-46;
    x.fillStyle="rgba(10,30,40,.65)";
    x.strokeStyle="rgba(160,230,255,.4)";
    x.lineWidth=1.5;
    x.beginPath();
    x.roundRect(btnX-btnW/2,btnY-18,btnW,btnH,14);
    x.fill();x.stroke();
    x.fillStyle="rgba(200,245,255,.9)";
    drawText(label,btnY,18);
  }else if(state===2){
    drawText("Crash!",cy-20,34);
    drawText("Tap to retry",cy+18,18);
  }
  x.setTransform(dpr,0,0,dpr,0,0);
}
requestAnimationFrame(loop);
</script>
